<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <style>
    .counties {
      fill: none;
    }
    .states {
      fill: none;
      stroke: #fff;
      stroke-linejoin: round;
    }
    </style>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
</head>
<body>

<svg width="960" height="600"></svg>

<script>
    var svg = d3.select("svg");
    svg.attr("preserveAspectRatio", "xMinYMin meet");
    svg.attr("width", window.innerWidth);
    svg.attr("height", window.innerHeight);

    var files = ["/api/backend", "map.json"];

    Promise.all(files.map(url => d3.json(url))).then(function(files) {
        ready(files[0], files[1])
    });

    function cluster_to_colorscheme(cluster){
        var max_id = -1;
        for(var key in cluster){
            max_id = Math.max(cluster[key], max_id);
        }
        var color_scheme = {}
        for(var key in cluster){
            var colIndex = (cluster[key]+1)/(max_id+1);
            color_scheme[key] = d3.color(d3.interpolateRainbow(colIndex)).hex();

        }
        return color_scheme;
    }

    function ready( clusters, map) {


      var projection = d3.geoEqualEarth();
      var outlines =  topojson.feature(
                map,
                map.objects["out"]).features;
      projection.fitSize([window.innerWidth, window.innerHeight], topojson.feature(
                map,
                map.objects["out"]));
      var path = d3.geoPath(projection);
      clusters = cluster_to_colorscheme(clusters);

      for(var feature in outlines){
        var state = outlines[feature].properties["iso_3166_2"];
        var fill = "#CCC";
        if(state in clusters){
            fill = clusters[state];
        } else {
            var country_code =state.split("-")[0]
            if(country_code in clusters){
                fill = clusters[country_code];
                console.log(fill)
            }
        }
        svg.append("path")
            .attr("fill", fill)
            .attr("d", path(outlines[feature]));

      }
    }


    </script>
</body>